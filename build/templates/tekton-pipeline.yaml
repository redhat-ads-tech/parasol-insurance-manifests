apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: parasol-insurance-tag-promote
  namespace: {{ .Values.namespace }}
spec:
  params:
    - name: git-tag
      type: string
    - name: git-revision
      type: string
  workspaces:
    - name: shared-workspace
  tasks:
    - name: build-tagged-image
      taskSpec:
        params:
          - name: IMAGE_TAG
            type: string
          - name: GIT_REVISION
            type: string
        steps:
          - name: create-buildrun
            image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
            script: |
              #!/bin/bash
              set -e
              cat <<BUILDRUN | oc apply -f -
              apiVersion: shipwright.io/v1beta1
              kind: BuildRun
              metadata:
                generateName: parasol-insurance-tag-
                namespace: {{ .Values.namespace }}
              spec:
                build:
                  name: {{ .Values.image.name }}
                source:
                  type: Git
                  git:
                    revision: $(params.GIT_REVISION)
                output:
                  image: {{ .Values.registry.host }}/{{ .Values.registry.organization }}/{{ .Values.image.name }}:$(params.IMAGE_TAG)
              BUILDRUN

              echo "BuildRun created for tag $(params.IMAGE_TAG)"

              # Wait for the BuildRun to complete
              sleep 5
              BUILDRUN_NAME=$(oc get buildruns -n {{ .Values.namespace }} --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.name}')
              echo "Waiting for BuildRun ${BUILDRUN_NAME} to complete..."

              oc wait --for=condition=Succeeded buildrun/${BUILDRUN_NAME} -n {{ .Values.namespace }} --timeout=30m
      params:
        - name: IMAGE_TAG
          value: $(params.git-tag)
        - name: GIT_REVISION
          value: $(params.git-revision)

    - name: open-prod-pr
      runAfter:
        - build-tagged-image
      taskRef:
        name: update-prod-manifest
      params:
        - name: IMAGE_TAG
          value: $(params.git-tag)
      workspaces:
        - name: source
          workspace: shared-workspace
